<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300..700&family=Space+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap"
    rel="stylesheet">

  <!-- Icons: Font Awesome by Dave Gandy - http://fontawesome.io -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />

  <title>Tic Tac Toe</title>
</head>

<body>
  <div class="wrapper">
    <div class="game-container">
      <div class="cell display small">
        <div class="display__title switch start">
          <div class="display__title-element">Tic</div>
          <div class="display__title-element">Tac</div>
          <div class="display__title-element">Toe</div>
        </div>
        <div class="display__symbol game switch">
          <div class="symbol x">X</div>
          <div class="symbol o">O</div>
        </div>
      </div>
      <div class="cell display large">
        <div class="switch start">
          <div class="display__message player bold">Player <span class="symbol"></span></div>
          <button class="display__button accept">Accept</button>
          <div class="display__message">Enter your name</div>
          <input type="text" class="display__input" maxlength="12">
        </div>
        <div class="switch game">
          <button class="display__button restart switched-on">Restart</button>
          <button class="display__button again">Play again</button>
          <div class="display__name">
            <div class="name x"></div>
            <div class="name o"></div>
          </div>
          <div class="display__end"></div>
        </div>
      </div>
      <div class="cell game-board__cell" data-index="0"></div>
      <div class="cell game-board__cell" data-index="1"></div>
      <div class="cell game-board__cell" data-index="2"></div>
      <div class="cell game-board__cell" data-index="3"></div>
      <div class="cell game-board__cell" data-index="4"></div>
      <div class="cell game-board__cell" data-index="5"></div>
      <div class="cell game-board__cell" data-index="6"></div>
      <div class="cell game-board__cell" data-index="7"></div>
      <div class="cell game-board__cell" data-index="8"></div>
    </div>
  </div>
  <script>
    const game = (() => {

  /* -------------------------------- Elements -------------------------------- */

  const elem = {
    buttonAccept: document.querySelector('.display__button.accept'),
    buttonRestart: document.querySelector('.display__button.restart'),
    buttonAgain: document.querySelector('.display__button.again'),
    inputName: document.querySelector('.display__input'),
    playerNameSymbol: document.querySelector('.display__message.player .symbol'),
    smallStartDisplay: document.querySelector('.display.small .start'),
    smallGameDisplay: document.querySelector('.display.small .game'),
    largeStartDisplay: document.querySelector('.display.large .start'),
    largeGameDisplay: document.querySelector('.display.large .game'),
    displayName: document.querySelector('.display__name'),
    displayEnd: document.querySelector('.display__end'),
    symbolX: document.querySelector('.display__symbol .symbol.x'),
    symbolO: document.querySelector('.display__symbol .symbol.o'),
    nameX: document.querySelector('.display__name .name.x'),
    nameO: document.querySelector('.display__name .name.o'),
    arrCells: Array.from(document.querySelectorAll('.game-board__cell'))
  }

  elem.arrStartDisplay = [elem.smallStartDisplay, elem.largeStartDisplay];
  elem.arrGameDisplay = [elem.smallGameDisplay, elem.largeGameDisplay];
  elem.arrElementsX = [elem.symbolX, elem.nameX];
  elem.arrElementsO = [elem.symbolO, elem.nameO];

  /* ---------------------------- Board constructor --------------------------- */

  function createBoard() {
    const board = [
      ['', '', ''],
      ['', '', ''],
      ['', '', ''],
    ];

    let isBlocked = true;

    const update = (symbol, row, column) => {
      if (board[row][column] === '') {
        board[row][column] = symbol;
        return 1;
      } else return 0;
    }

    return { update, board, isBlocked };
  }

  /* ------------------------ Game variables/constants ------------------------ */

  let board = createBoard();
  const PLAYERS = [];
  let currentPlayer = 0;

  /* ---------------------------- Helper functions ---------------------------- */

  const switchElements = (arrOn, arrOff) => {
    arrOn.forEach(elem => elem.classList.add('switched-on'));
    arrOff.forEach(elem => elem.classList.remove('switched-on'));
  }

  const toggleElements = arr => {
    arr.forEach(elem => elem.classList.toggle('switched-on'));
  }

  const showHideElements = (arrShow, arrHide) => {
    arrShow.forEach(elem => elem.classList.remove('hidden'));
    arrHide.forEach(elem => elem.classList.add('hidden'));
  }

  const fillCell = index => {
    elem.arrCells[index].textContent = PLAYERS[currentPlayer].symbol;
    switchElements([], [elem.arrCells[index]]);
    elem.arrCells[index].classList.add('filled');
  }

  const unfillCell = type => {
    if (type !== 'class' && type !== 'text') return;

    elem.arrCells.forEach(item => {
      type === 'class' ? item.classList.remove('filled', 'winning') : item.textContent = '';
    });
  }

  const highlightCells = cells => {
    cells.forEach(cell => {
      const index = calculateIndex(cell[0], cell[1]);
      elem.arrCells[index].classList.add('winning');
    })
  }

  const calculateIndex = (row, column) => {
    return row * 3 + column;
  }

  /* ------------------------------- Game logic ------------------------------- */

  const createPlayer = (symbol) => {
    return new Promise(resolve => {
      elem.playerNameSymbol.textContent = symbol;
      elem.inputName.value = '';
      setTimeout(() => elem.inputName.focus(), 100);

      const handleEnterPress = event => {
        if (event.key === "Enter") handleAccept();
      }

      const handleAccept = () => {
        const name = elem.inputName.value.trim();
        if (name) {
          elem.buttonAccept.removeEventListener('click', handleAccept);
          elem.inputName.removeEventListener('keydown', handleEnterPress);
          elem.inputName.value = '';
          handleInput();
          resolve({ name, symbol });
        }
      };

      elem.buttonAccept.addEventListener('click', handleAccept);
      elem.inputName.addEventListener('keydown', handleEnterPress);
    })
  }

  const initGame = async () => {

    unfillCell('class');
    switchElements([...elem.arrStartDisplay], [...elem.arrGameDisplay, elem.nameX, elem.nameO]);

    elem.smallStartDisplay.addEventListener("transitionend", () => {
      switchElements([elem.symbolX], [elem.symbolO]);
    }, { once: true });

    PLAYERS.splice(0, PLAYERS.length,
      await createPlayer('X'),
      await createPlayer('O')
    );

    showHideElements([], [elem.displayEnd]);

    currentPlayer = 0;
    elem.nameX.textContent = PLAYERS[0].name;
    elem.nameO.textContent = PLAYERS[1].name;

    unfillCell('text');
    switchElements(
      [...elem.arrElementsX, ...elem.arrCells, ...elem.arrGameDisplay, elem.displayName],
      [...elem.arrStartDisplay, elem.buttonAgain, elem.displayEnd]
    );

    setTimeout(() => {
      showHideElements([elem.displayEnd], []);
    }, 1000);

    elem.buttonRestart.disabled = false;
    elem.buttonAgain.disabled = false;
    board.isBlocked = false;
  }

  const checkForWin = () => {
    const brd = board.board;
    let isDraw = true;
    let winningCells = [];

    const checkLine = (a, b, c) => a && a === b && b === c;

    if (checkLine(brd[0][0], brd[1][1], brd[2][2])) {
      winningCells = [[0, 0], [1, 1], [2, 2]];
    } else if (checkLine(brd[0][2], brd[1][1], brd[2][0])) {
      winningCells = [[0, 2], [1, 1], [2, 0]];
    } else {
      for (let i = 0; i <= 2; i++) {
        if (brd[i].includes('')) isDraw = false;
        if (checkLine(brd[0][i], brd[1][i], brd[2][i])) {
          winningCells = [[0, i], [1, i], [2, i]];
          break;
        }
        if (checkLine(brd[i][0], brd[i][1], brd[i][2])) {
          winningCells = [[i, 0], [i, 1], [i, 2]];
          break;
        }
      }
    }

    if (winningCells.length) {
      highlightCells(winningCells);
      return handleEnd('win');
    }

    if (isDraw) return handleEnd('draw');

    return 0;
  }

  const handleEnd = end => {
    board.isBlocked = true;
    switchElements([elem.buttonAgain, elem.displayEnd], [...elem.arrCells, elem.displayName]);
    elem.buttonAgain.disabled = false;
    if (end === 'win') {
      elem.displayEnd.textContent = `${PLAYERS[currentPlayer].name} won!\nCongratulations!`
    } else if (end === 'draw') {
      elem.displayEnd.textContent = `It's a draw!`;
    }
    return 1;
  }

  const play = (row, column) => {
    if (!board.isBlocked) {
      if (board.update(PLAYERS[currentPlayer].symbol, row, column)) {
        fillCell(calculateIndex(row, column));
        if (!checkForWin()) {
          currentPlayer = ++currentPlayer % 2;
          toggleElements([...elem.arrElementsX, ...elem.arrElementsO]);
        } else return
      };
    }
  }

  /* -------------------------------- Handlers -------------------------------- */

  const handleInput = () => {
    const enabled = Boolean(elem.inputName.value.trim());
    elem.buttonAccept.classList.toggle('switched-on', enabled);
    elem.buttonAccept.disabled = !enabled;
  }

  const restartGame = () => {
    elem.buttonRestart.disabled = true;
    elem.buttonAgain.disabled = true;
    if (!elem.displayEnd.classList.contains('switched-on')) showHideElements([], [elem.displayEnd]);
    board = createBoard();
    initGame();
  }

  const playAgain = () => {

    unfillCell('class')
    board = createBoard();
    currentPlayer = 0;

    switchElements(
      [...elem.arrElementsX, elem.displayName],
      [...elem.arrElementsO, ...elem.arrCells, elem.buttonAgain, elem.displayEnd]
    );
    elem.buttonAgain.disabled = true;

    setTimeout(() => {
      unfillCell('text');
      board.isBlocked = false;
      switchElements(elem.arrCells, []);
    }, 600);
  }

  const handleCell = event => {

    const index = Number(event.target.dataset.index)
    const row = Math.floor(index / 3);
    const col = index % 3;

    play(row, col);
  }

  /* --------------------------------- Events --------------------------------- */

  elem.inputName.addEventListener('input', handleInput);
  elem.buttonRestart.addEventListener('click', restartGame);
  elem.buttonAgain.addEventListener('click', playAgain);
  elem.arrCells.forEach(item => {
    item.addEventListener('click', handleCell);
  })

  /* -------------------------------- Init game ------------------------------- */

  document.addEventListener("DOMContentLoaded", () => {
    initGame();
  });

})();

  </script>
</body>
</html>
